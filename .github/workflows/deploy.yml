# ============================================================
# Deploy — Push to Hugging Face Spaces on main branch
# ============================================================
# Triggers after CI passes on main, or after a training run.
# Copies serving code + model to the HF Space repo and pushes.
# ============================================================

name: Deploy — HF Spaces

on:
  # Auto-deploy after CI passes on main
  workflow_run:
    workflows: ["CI — Lint & Test"]
    types: [completed]
    branches: [main]

  # Manual deploy button
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: hf-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Hugging Face Spaces
    runs-on: ubuntu-latest
    # Only deploy if CI succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install dvc huggingface_hub

      - name: Pull DVC data (model files)
        run: |
          dvc pull models/distilbert_sentiment/ models/distilbert_info.json || echo "Trying local cache..."

      - name: Verify model files exist
        run: |
          echo "Checking required model files..."
          test -f models/distilbert_sentiment/config.json       || { echo "❌ config.json missing"; exit 1; }
          test -f models/distilbert_sentiment/model.safetensors || { echo "❌ model.safetensors missing"; exit 1; }
          test -f models/distilbert_sentiment/tokenizer.json    || { echo "❌ tokenizer.json missing"; exit 1; }
          echo "✅ All model files present"
          ls -lh models/distilbert_sentiment/

      - name: Deploy to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e

          HF_USER="sairam030"
          SPACE_NAME="sentiment-api"
          SPACE_REPO="${HF_USER}/${SPACE_NAME}"
          DEPLOY_DIR="/tmp/hf_deploy"

          # Clone the Space repo
          git clone "https://${HF_USER}:${HF_TOKEN}@huggingface.co/spaces/${SPACE_REPO}" "${DEPLOY_DIR}"
          cd "${DEPLOY_DIR}"
          git lfs install

          # Clean old files (keep .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy HF Space config
          cp "$GITHUB_WORKSPACE/hf_space/Dockerfile" .
          cp "$GITHUB_WORKSPACE/hf_space/README.md" .
          cp "$GITHUB_WORKSPACE/hf_space/requirements.txt" .

          # Copy serving code (exclude secrets/env files)
          cp -r "$GITHUB_WORKSPACE/serving" .
          rm -f serving/.env.* serving/.env

          # Copy model files
          mkdir -p model
          cp "$GITHUB_WORKSPACE/models/distilbert_sentiment/config.json" model/
          cp "$GITHUB_WORKSPACE/models/distilbert_sentiment/model.safetensors" model/
          cp "$GITHUB_WORKSPACE/models/distilbert_sentiment/tokenizer.json" model/
          cp "$GITHUB_WORKSPACE/models/distilbert_sentiment/tokenizer_config.json" model/
          [ -f "$GITHUB_WORKSPACE/models/distilbert_info.json" ] && \
            cp "$GITHUB_WORKSPACE/models/distilbert_info.json" model/

          # LFS track large files
          git lfs track "*.safetensors" "*.bin" "*.pt"

          # Commit and push
          git add -A
          COMMIT_SHA=$(echo "$GITHUB_SHA" | head -c 8)
          git diff --cached --quiet || git commit -m "deploy: ${COMMIT_SHA} — auto-deploy from GitHub Actions"
          git push origin main

          echo ""
          echo "✅ Deployed to https://${HF_USER}-${SPACE_NAME}.hf.space"
